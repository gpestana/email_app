var Imap  = require('imap'),
inspect   = require('util').inspect,
login     = require('./login.js')

var imap = new Imap({
  user: login.user, 
  password: login.pass,
  host: login.host_imap,
  port: 993,
  tls: true
})

var cb

//priv and public methods
var openInbox = function(cb) {
  imap.openBox('INBOX', true, cb)
}

var connect = function(cback) {
  cb = cback
  imap.connect()
}

//event handlers
imap.once('ready', function(){
   
  openInbox(function(err, box){
    if(err) throw err
    
    //request 
    var f = imap.seq.fetch('1:3', {
      bodies: 'HEADER.FIELDS (FROM TO SUBJECT DATE)',
      struct: true
    })
   
    
    f.on('message', function(msg, seqno) {
      var prefix = '[#' + seqno + ']';
      console.log(prefix)
    
      msg.on('body', function(stream, info) {
        console.log(info)
          
        //parse email streams
        var buffer = ''
        stream.on('data', function(chunk) {
          buffer =+ chunk.toString('utf8')
        })  
        stream.on('end', function(){
          console.log(prefix+" parsed")
          console.log(buffer) 
        })  
      })
      
      msg.once('end', function(){
        console.log(prefix + 'Finished');
        //cb()
      })
    })
  }) 
})



exports.connect = connect
